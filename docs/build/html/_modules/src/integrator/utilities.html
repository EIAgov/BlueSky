<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.integrator.utilities &mdash; BlueSky Prototype Model v1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5cb08e4e"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            BlueSky Prototype Model
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.integrator.html">src.integrator package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.electricity.html">src.models.electricity package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.html">src package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.html">src.models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.residential.scripts.html">src.models.residential.scripts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.residential.html">src.models.residential package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.residential.preprocessor.html">src.models.residential.preprocessor package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.hydrogen.utilities.html">src.models.hydrogen.utilities package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.hydrogen.html">src.models.hydrogen package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.hydrogen.network.html">src.models.hydrogen.network package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.hydrogen.model.html">src.models.hydrogen.model package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.electricity.scripts.html">src.models.electricity.scripts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src.models.electricity.scripts.common.html">src.models.electricity.scripts.common package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">BlueSky Prototype Model</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.integrator.utilities</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.integrator.utilities</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A gathering of utility functions for dealing with model interconnectivity</span>

<span class="sd">Dev Note:  At some review point, some decisions may move these back &amp; forth with parent</span>
<span class="sd">models after it is decided if it is a utility job to do .... or a class method.</span>

<span class="sd">Additionally, there is probably some renaming due here for consistency</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># for easier/accurate indexing</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">pyomo.opt</span> <span class="k">as</span> <span class="nn">pyo</span>
<span class="kn">from</span> <span class="nn">pyomo.environ</span> <span class="kn">import</span> <span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">value</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">definitions</span> <span class="kn">import</span> <span class="n">PROJECT_ROOT</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">src.models.electricity.scripts.electricity_model</span> <span class="kn">import</span> <span class="n">PowerModel</span>
    <span class="kn">from</span> <span class="nn">src.models.hydrogen.model.h2_model</span> <span class="kn">import</span> <span class="n">H2Model</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_output_root">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.get_output_root">[docs]</a>
<span class="k">def</span> <span class="nf">get_output_root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;get the name of the output dir, which includes the name of the mode type and a timestamp</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    path</span>
<span class="sd">        output directory path</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;output_root.txt&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output_root.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">OUTPUT_ROOT</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">OUTPUT_ROOT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_ROOT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">OUTPUT_ROOT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROJECT_ROOT</span> <span class="o">/</span> <span class="s1">&#39;output&#39;</span> <span class="o">/</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OUTPUT_ROOT</span></div>



<div class="viewcode-block" id="make_dir">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.make_dir">[docs]</a>
<span class="k">def</span> <span class="nf">make_dir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;generates an output directory to write model results, output directory is the date/time</span>
<span class="sd">    at the time this function executes. It includes subdirs for vars, params, constraints.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    string</span>
<span class="sd">        the name of the output directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Asked to make dir that already exists:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dir_name</span><span class="p">))</span></div>



<span class="c1"># TODO:  This might be a good use case for a persistent solver (1-each) for both the elec &amp; hyd...  hmm</span>
<div class="viewcode-block" id="simple_solve">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.simple_solve">[docs]</a>
<span class="k">def</span> <span class="nf">simple_solve</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">ConcreteModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a simple solve routine&quot;&quot;&quot;</span>

    <span class="c1"># Note:  this is a prime candidate to split into 2 persistent solvers!!</span>
    <span class="c1"># TODO:  experiment with pyomo&#39;s persistent solver interface, one for each ELEC, H2</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">select_solver</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pyo</span><span class="o">.</span><span class="n">check_optimal_termination</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;failed solve in iterator&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="simple_solve_no_opt">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.simple_solve_no_opt">[docs]</a>
<span class="k">def</span> <span class="nf">simple_solve_no_opt</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">ConcreteModel</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve concrete model using solver factory object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m : ConcreteModel</span>
<span class="sd">        Pyomo model</span>
<span class="sd">    opt: SolverFactory</span>
<span class="sd">        Solver object initiated prior to solve</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Note:  this is a prime candidate to split into 2 persistent solvers!!</span>
    <span class="c1"># TODO:  experiment with pyomo&#39;s persistent solver interface, one for each ELEC, H2</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;solving w/ solver-factory object instantiated outside of loop&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pyo</span><span class="o">.</span><span class="n">check_optimal_termination</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;failed solve in iterator&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="select_solver">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.select_solver">[docs]</a>
<span class="k">def</span> <span class="nf">select_solver</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">ConcreteModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select solver based on learning method</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instance : PowerModel</span>
<span class="sd">        electricity pyomo model</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    solver type (?)</span>
<span class="sd">        The pyomo solver</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># default = linear solver</span>
    <span class="n">solver_name</span> <span class="o">=</span> <span class="s1">&#39;appsi_highs&#39;</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver_name</span><span class="p">)</span>
    <span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;sw_learning&#39;</span><span class="p">):</span>  <span class="c1"># check if sw_learning exists in model (electricity model)</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">sw_learning</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># nonlinear solver</span>
            <span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;elec&#39;</span><span class="p">):</span>  <span class="c1"># check if sw_learning exists in meta unified model</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">elec</span><span class="p">,</span> <span class="s1">&#39;sw_learning&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">elec</span><span class="o">.</span><span class="n">sw_learning</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># nonlinear solver</span>
                <span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">nonlinear_solver</span><span class="p">:</span>  <span class="c1"># if nonlinear learning, set to ipopt</span>
        <span class="n">solver_name</span> <span class="o">=</span> <span class="s1">&#39;ipopt&#39;</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">pyo</span><span class="o">.</span><span class="n">SolverFactory</span><span class="p">(</span><span class="n">solver_name</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># , tee=True</span>
        <span class="c1"># Select options. The prefix &quot;OF_&quot; tells pyomo to create an options file</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;OF_mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;adaptive&#39;</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;OF_num_linear_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;OF_mehrotra_algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="c1"># Ask IPOPT to print options so you can confirm that they were used by the solver</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using Solver: &#39;</span> <span class="o">+</span> <span class="n">solver_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">opt</span></div>



<span class="c1"># Logger Setup</span>
<div class="viewcode-block" id="setup_logger">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.setup_logger">[docs]</a>
<span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;initiates logging, sets up logger in the output directory specified</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output_dir : path</span>
<span class="sd">        output directory path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set up root logger</span>
    <span class="n">log_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
        <span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/run.log&#39;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
        <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
        <span class="c1"># format=&#39;[%(asctime)s][%(name)s]&#39; + &#39;[%(funcName)s][%(levelname)s]  :: |%(message)s|&#39;,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(name)s</span><span class="s1"> | </span><span class="si">%(levelname)s</span><span class="s1"> :: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b-%y %H:%M:%S&#39;</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pyomo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pandas&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span></div>



<span class="c1"># a named tuple for common electric model index structure (EI=Electrical Index)</span>
<span class="n">EI</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EI&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">])</span>
<span class="sd">&quot;&quot;&quot;(region, year, hour)&quot;&quot;&quot;</span>
<span class="n">HI</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;HI&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span>
<span class="sd">&quot;&quot;&quot;(region, year)&quot;&quot;&quot;</span>


<div class="viewcode-block" id="get_elec_price">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.get_elec_price">[docs]</a>
<span class="k">def</span> <span class="nf">get_elec_price</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;PowerModel&#39;</span><span class="p">,</span> <span class="n">ConcreteModel</span><span class="p">],</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pulls hourly electricity prices from completed PowerModel and de-weights them</span>

<span class="sd">    Prices from the duals are weighted by the day and year weights applied in the OBJ function</span>
<span class="sd">    This function retrieves the prices for all hours and removes the day and annual weights to</span>
<span class="sd">    return raw prices (and the day weights to use as needed)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instance : PowerModel</span>
<span class="sd">        solved electricity model</span>

<span class="sd">    block: ConcreteModel</span>
<span class="sd">        reference to the block if the electricity model is a block within a larger model</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        df of raw prices and the day weights to re-apply (if needed)</span>
<span class="sd">        columns: [r, y, hour, day_weight, raw_price]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">demand_balance</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">block</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">demand_balance</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">instance</span>

    <span class="c1"># get electricity price duals and de-weight them (costs in the OBJ are up-weighted</span>
    <span class="c1"># by the day weight and year weight)</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="n">EI</span><span class="p">(</span><span class="o">*</span><span class="n">index</span><span class="p">)</span>
        <span class="n">weighted_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">dual</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>

        <span class="c1"># gather the weights for this hour</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Map_hr_d</span><span class="p">[</span><span class="n">ei</span><span class="o">.</span><span class="n">hour</span><span class="p">]</span>
        <span class="n">day_wt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Idaytq</span><span class="p">[</span><span class="n">day</span><span class="p">]</span>
        <span class="n">year_wt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">year_weights</span><span class="p">[</span><span class="n">ei</span><span class="o">.</span><span class="n">year</span><span class="p">]</span>

        <span class="c1"># remove the weighting &amp; record</span>
        <span class="n">unweighted_cost</span> <span class="o">=</span> <span class="n">weighted_value</span> <span class="o">/</span> <span class="n">day_wt</span> <span class="o">/</span> <span class="n">year_wt</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">*</span><span class="n">ei</span><span class="p">,</span> <span class="n">day_wt</span><span class="p">,</span> <span class="n">unweighted_cost</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;day_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_price&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="get_annual_wt_avg">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.get_annual_wt_avg">[docs]</a>
<span class="k">def</span> <span class="nf">get_annual_wt_avg</span><span class="p">(</span><span class="n">elec_price</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;takes annual weighted average of hourly electricity prices</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elec_price : pd.DataFrame</span>
<span class="sd">        hourly electricity prices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[HI, float]</span>
<span class="sd">        annual weighted average electricity prices</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">my_agg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;weighted_ave_price&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;day_weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;raw_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;day_weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;weighted_ave_price&#39;</span><span class="p">])</span>

    <span class="c1"># find annual weighted average, weight by day weights</span>
    <span class="n">elec_price_ann</span> <span class="o">=</span> <span class="n">elec_price</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">my_agg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elec_price_ann</span></div>



<div class="viewcode-block" id="regional_annual_prices">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.regional_annual_prices">[docs]</a>
<span class="k">def</span> <span class="nf">regional_annual_prices</span><span class="p">(</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;PowerModel&#39;</span><span class="p">,</span> <span class="n">ConcreteModel</span><span class="p">],</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;pulls all regional annual weighted electricity prices</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m : typing.Union[&#39;PowerModel&#39;, ConcreteModel]</span>
<span class="sd">        solved PowerModel</span>
<span class="sd">    block :  optional</span>
<span class="sd">        solved block model if applicable, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[HI, float]</span>
<span class="sd">        dict with regional annual electricity prices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">get_elec_price</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">get_annual_wt_avg</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>

    <span class="c1"># convert from dataframe to dictionary</span>
    <span class="n">lut</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ap</span><span class="o">.</span><span class="n">to_records</span><span class="p">():</span>
        <span class="n">region</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">lut</span><span class="p">[</span><span class="n">HI</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)]</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">return</span> <span class="n">lut</span></div>



<div class="viewcode-block" id="convert_elec_price_to_lut">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.convert_elec_price_to_lut">[docs]</a>
<span class="k">def</span> <span class="nf">convert_elec_price_to_lut</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">EI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">EI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;convert electricity prices to dictionary, look up table</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prices : list[tuple[EI, float]]</span>
<span class="sd">        list of prices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[EI, float]</span>
<span class="sd">        dict of prices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
        <span class="n">ei</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">res</span><span class="p">[</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="poll_hydrogen_price">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.poll_hydrogen_price">[docs]</a>
<span class="k">def</span> <span class="nf">poll_hydrogen_price</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;H2Model&#39;</span><span class="p">,</span> <span class="n">ConcreteModel</span><span class="p">],</span> <span class="n">block</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the price of H2 from the H2 model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : H2Model</span>
<span class="sd">        the model to poll</span>
<span class="sd">    block: optional</span>
<span class="sd">        block model to poll</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[tuple[HI, float]]</span>
<span class="sd">        list of H2 Index, price tuples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ensure valid class</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ConcreteModel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid input&#39;</span><span class="p">)</span>

    <span class="c1"># TODO:  what should happen if there is no entry for a particular region (no hubs)?</span>
    <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
        <span class="n">demand_constraint</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">demand_constraint</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">demand_constraint</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">demand_constraint</span>
    <span class="c1"># print(&#39;************************************\n&#39;)</span>
    <span class="c1"># print(list(demand_constraint.index_set()))</span>
    <span class="c1"># print(list(model.dual.keys()))</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="n">HI</span><span class="p">(</span><span class="o">*</span><span class="n">k</span><span class="p">),</span> <span class="n">model</span><span class="o">.</span><span class="n">dual</span><span class="p">[</span><span class="n">demand_constraint</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">demand_constraint</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>  <span class="c1"># type: ignore</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;current h2 prices:  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rows</span>  <span class="c1"># type: ignore</span></div>



<div class="viewcode-block" id="convert_h2_price_records">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.convert_h2_price_records">[docs]</a>
<span class="k">def</span> <span class="nf">convert_h2_price_records</span><span class="p">(</span><span class="n">records</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;simple coversion from list of records to a dictionary LUT</span>
<span class="sd">    repeat entries should not occur and will generate an error&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">hi</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Duplicate index for h2 price received in coversion: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;duplicate index received see log file.&#39;</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>

    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="poll_year_avg_elec_price">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.poll_year_avg_elec_price">[docs]</a>
<span class="k">def</span> <span class="nf">poll_year_avg_elec_price</span><span class="p">(</span><span class="n">price_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">EI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;retrieve a REPRESENTATIVE price at the annual level from a listing of prices</span>

<span class="sd">    This function computes the AVERAGE elec price for each region-year combo</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    price_list : list[tuple[EI, float]]</span>
<span class="sd">        input price list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[HI, float]</span>
<span class="sd">        a dictionary of (region, year): price</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">year_region_records</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ei</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">price_list</span><span class="p">:</span>
        <span class="n">year_region_records</span><span class="p">[</span><span class="n">HI</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">ei</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">ei</span><span class="o">.</span><span class="n">year</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>

    <span class="c1"># now gather the averages...</span>
    <span class="k">for</span> <span class="n">hi</span> <span class="ow">in</span> <span class="n">year_region_records</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">year_region_records</span><span class="p">[</span><span class="n">hi</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_region_records</span><span class="p">[</span><span class="n">hi</span><span class="p">])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Computed these region-year averages for elec price: </span><span class="se">\n\t</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="poll_h2_prices_from_elec">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.poll_h2_prices_from_elec">[docs]</a>
<span class="k">def</span> <span class="nf">poll_h2_prices_from_elec</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="s1">&#39;PowerModel&#39;</span><span class="p">,</span> <span class="n">tech</span><span class="p">,</span> <span class="n">regions</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Iterable</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;poll the step-1 H2 price currently in the model for region/year, averaged over any steps&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">H2Price</span><span class="p">:</span>
        <span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">tech</span> <span class="ow">and</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regions</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># TODO:  remove hard coding</span>
            <span class="n">res</span><span class="p">[</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">H2Price</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="update_h2_prices">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.update_h2_prices">[docs]</a>
<span class="k">def</span> <span class="nf">update_h2_prices</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="s1">&#39;PowerModel&#39;</span><span class="p">,</span> <span class="n">h2_prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the H2 prices held in the model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h2_prices : list[tuple[HI, float]]</span>
<span class="sd">        new prices</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO:  Fix this hard-coding below!</span>
    <span class="n">h2_techs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">}</span>  <span class="c1"># temp hard-coding of the tech who&#39;s price we&#39;re going to set</span>

    <span class="n">update_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">no_update</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">good_updates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">H2Price</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">h2_techs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">yr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">h2_prices</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">H2Price</span><span class="p">[</span><span class="n">region</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="n">h2_prices</span><span class="p">[</span><span class="n">HI</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">yr</span><span class="p">)]</span>
                <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">good_updates</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">region</span><span class="p">,</span> <span class="n">yr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">no_update</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">region</span><span class="p">,</span> <span class="n">yr</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updated </span><span class="si">%d</span><span class="s1"> H2 prices: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">update_count</span><span class="p">,</span> <span class="n">good_updates</span><span class="p">)</span>

    <span class="c1"># check for any missing data</span>
    <span class="k">if</span> <span class="n">no_update</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No new price info for region-year combos: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">no_update</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_elec_demand">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.update_elec_demand">[docs]</a>
<span class="k">def</span> <span class="nf">update_elec_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elec_demand</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the external electical demand parameter with demands from the H2 model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elec_demand : dict[HI, float]</span>
<span class="sd">        the new demands broken out by hyd index (region, year)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is kind of a 1-liner right now, but may evolve into something more elaborate when</span>
    <span class="c1"># time scale is tweaked</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">FixedElecRequest</span><span class="o">.</span><span class="n">store_values</span><span class="p">(</span><span class="n">elec_demand</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stored new fixed electrical request in elec model: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">elec_demand</span><span class="p">)</span></div>



<div class="viewcode-block" id="poll_h2_demand">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.poll_h2_demand">[docs]</a>
<span class="k">def</span> <span class="nf">poll_h2_demand</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="s1">&#39;PowerModel&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the hydrogen demand by rep_year and region</span>

<span class="sd">    Use the Generation variable for h2 techs</span>

<span class="sd">    NOTE:  Not sure about day weighting calculation here!!</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[HI, float]</span>
<span class="sd">        dictionary of prices by H2 Index: price</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h2_consuming_techs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">}</span>  <span class="c1"># TODO:  get rid of this hard-coding</span>

    <span class="c1"># gather results</span>
    <span class="n">res</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">HI</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">tot_by_rep_year</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># iterate over the Generation variable and screen out the H2 &quot;demanders&quot;</span>
    <span class="c1"># dimensional analysis for H2 demand:</span>
    <span class="c1">#</span>
    <span class="c1"># Gwh * kg/Gwh = kg</span>
    <span class="c1"># so we need 1/heat_rate for kg/Gwh</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">generation_total</span><span class="o">.</span><span class="n">index_set</span><span class="p">():</span>
        <span class="n">tech</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">if</span> <span class="n">tech</span> <span class="ow">in</span> <span class="n">h2_consuming_techs</span><span class="p">:</span>
            <span class="n">h2_demand_weighted</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">generation_total</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">Idaytq</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Map_hr_d</span><span class="p">[</span><span class="n">hr</span><span class="p">]]</span>
                <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">H2_heatrate</span>
            <span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">HI</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">y</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">h2_demand_weighted</span>
            <span class="n">tot_by_rep_year</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="n">h2_demand_weighted</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculated cumulative H2 demand by year as: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tot_by_rep_year</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="create_temporal_mapping">
<a class="viewcode-back" href="../../../src.integrator.html#src.integrator.utilities.create_temporal_mapping">[docs]</a>
<span class="k">def</span> <span class="nf">create_temporal_mapping</span><span class="p">(</span><span class="n">sw_temporal</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combines the input mapping files within the electricity model to create a master temporal</span>
<span class="sd">    mapping dataframe. The df is used to build multiple temporal parameters used within the  model.</span>
<span class="sd">    It creates a single dataframe that has 8760 rows for each hour in the year.</span>
<span class="sd">    Each hour in the year is assigned a season type, day type, and hour type used in the model.</span>
<span class="sd">    This defines the number of time periods the model will use based on cw_s_day and cw_hr inputs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dataframe</span>
<span class="sd">        a dataframe with 8760 rows that include each hour, hour type, day, day type, and season.</span>
<span class="sd">        It also includes the weights for each day type and hour type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Temporal Sets - read data</span>
    <span class="c1"># SD = season/day; hr = hour</span>
    <span class="n">data_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s1">&#39;src/integrator/input&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sw_temporal</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="n">sd_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_root</span> <span class="o">/</span> <span class="s1">&#39;cw_s_day.csv&#39;</span><span class="p">)</span>
        <span class="n">hr_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_root</span> <span class="o">/</span> <span class="s1">&#39;cw_hr.csv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cw_s_day</span> <span class="o">=</span> <span class="s1">&#39;cw_s_day_&#39;</span> <span class="o">+</span> <span class="n">sw_temporal</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
        <span class="n">cw_hr</span> <span class="o">=</span> <span class="s1">&#39;cw_hr_&#39;</span> <span class="o">+</span> <span class="n">sw_temporal</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
        <span class="n">sd_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_root</span> <span class="o">/</span> <span class="s1">&#39;temporal_mapping&#39;</span> <span class="o">/</span> <span class="n">cw_s_day</span><span class="p">)</span>
        <span class="n">hr_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_root</span> <span class="o">/</span> <span class="s1">&#39;temporal_mapping&#39;</span> <span class="o">/</span> <span class="n">cw_hr</span><span class="p">)</span>

    <span class="c1"># set up mapping for seasons and days</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">sd_file</span>
    <span class="n">df4</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Map_day&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">df4</span> <span class="o">=</span> <span class="n">df4</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Index_day&#39;</span><span class="p">:</span> <span class="s1">&#39;Dayweights&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Map_s&#39;</span><span class="p">])</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df4</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Map_day&#39;</span><span class="p">])</span>

    <span class="c1"># set up mapping for hours</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">hr_file</span>
    <span class="n">df3</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Map_hr&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">df3</span> <span class="o">=</span> <span class="n">df3</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Index_hr&#39;</span><span class="p">:</span> <span class="s1">&#39;Hr_weights&#39;</span><span class="p">})</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Map_hr&#39;</span><span class="p">])</span>

    <span class="c1"># combine season, day, and hour mapping</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;cross&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hr&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Map_hr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Map_day&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Map_hr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Map_hr&#39;</span><span class="p">]</span>
    <span class="c1"># df.to_csv(data_root/&#39;temporal_map.csv&#39;,index=False)</span>

    <span class="k">return</span> <span class="n">df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, U.S. Energy Information Administration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>