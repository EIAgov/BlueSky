# Residential Preprocessor

### Table of Contents
- [Introduction](#introduction)
- [Prepare Data](#prepare-data)
- [Model Overview](#model-overview)
- [Code Documentation](#code-documentation)

## Introduction

The residential preprocessor builds many of the input files used within the residential module. The preprocessor code is built upon three main files:
 - generate_inputs.py
 - enduse_db.py
 - enduse_demand.py

The inputs for the residential module are pre-built within the project. The files in the preprocessor allow users to see how the input files were created and/or allow users to modify input assumptions to explore possible alternative scenarios. 

The preprocessor builds the [BaseElecPrice.csv](/src/models/residential/input/BaseElecPrice.csv) and [Load.csv](/src/models/residential/input/Load.csv) used within the residential module. The BaseElecPrice.csv file provides an initial set of hourly electricity prices for all regions for the first model year. The Load.csv file projects electricity demand for future model years based on the [BaseLoad.csv](/src/models/residential/input/BaseLoad.csv) and the other assumptions described in the Generate Inputs section. 

If users are interested in reproducing or modifying [BaseElecPrice.csv](/src/models/residential/input/BaseElecPrice.csv) file, they can jump to the Generate Inputs section. There are two methods for generating the [Load.csv](/src/models/residential/input/Load.csv) file (the simple version and enduse demand version). Both versions are generated using the Generate Inputs file, but the Enduse-based approach uses additional data that is generated by the Enduse Database and the Enduse Demand code.

## Prepare Data

To reproduce the [BaseElecPrice.csv](/src/models/residential/input/BaseElecPrice.csv) file or the [Load.csv](/src/models/residential/input/Load.csv) file, users can edit the Generate Inputs section to run the method they prefer to generate the inputs. There are two methods for generating the [Load.csv](/src/models/residential/input/Load.csv) file (the simple version and enduse demand version). If users are interested in changing the assumptions for the enduse demand version of the [Load.csv](/src/models/residential/input/Load.csv) file, they may also wish to run the [enduse_db.py](/src/models/residential/preprocessor/enduse_db.py) file and the [enduse_demand.py](/src/models/residential/preprocessor/enduse_demand.py) file.

## Model Overview

### Generate Inputs

The generate inputs code creates the [BaseElecPrice.csv](/src/models/residential/input/BaseElecPrice.csv) and [Load.csv](/src/models/residential/input/Load.csv) files located in the input directory. 

#### BaseElecPrice.csv
To reproduce the [BaseElecPrice.csv](/src/models/residential/input/BaseElecPrice.csv) file, uncomment out the base_price function at the end of the generate inputs script. 

This code uses the [baseprice_config.toml](/src/models/residential/input/preprocessor_inputs/baseprice_config.toml) file, as well as the [sw_reg_bp.csv](/src/models/residential/input/preprocessor_inputs/sw_reg_bp.csv) and [sw_year_bp.csv](/src/models/residential/input/preprocessor_inputs/sw_year_bp.csv) files to run the electricity module and generate hourly electricity prices for all regions for the first model year. It saves those prices as within the input directory of the residential module. 

#### Load.csv

There are two methods available to users for producing the Load.csv input file. The simple method and the enduse-based method. The default version stored in the project is based on the enduse-based method.

*Simple Method:* uncomment out the scale_load function at the end of the generate inputs code. The simple method uses [LoadScalar.csv](/src/models/residential/input/preprocessor_inputs/LoadScalar.csv) in the proprocessor_inputs directory and the [BaseLoad.csv](/src/models/residential/input/BaseLoad.csv) in the input. The load scalar file contains an annual incremental percent growth value for each model year. The function multiplies each hourly electricity demand for each region by the scalar value assigned to each year and then outputs the load. 

*Enduse Method*: uncomment out the scale_load_with_enduses function at the end of the generate inputs code. The enduse method scales each enduse category separately by an annual incremental percent growth value for each model year. To calculate the annual scaling factor, the function multiplies the assumed shared of annual base load for each enduse category as specified in the [EnduseBaseShares.csv](/src/models/residential/input/preprocessor_inputs/EnduseBaseShares.csv) file by the annual scaling factor for each enduse category as specified in the [EnduseScalar.csv](/src/models/residential/input/preprocessor_inputs/EnduseScalar.csv) file. The function also creates a new enduse category called "everything_else" which is just a flat demand profile. The function then multiplies each hourly electricity demand for each region as specified in the [enduse_shapes.csv](/src/models/residential/input/preprocessor_inputs/enduse_shapes.csv) by the scalar value assigned to each year and enduse category and then outputs the load. 

Users can use the default values provided pr create a new enduse_shapes.csv file by running the enduse database and enduse demand code. 

#### Enduse Database

The enduse database code sources data from the National Renewable Energy Laboratory (NREL) Open Energy Data Initiative (OEDI). The database collects and stores web data developed using the Resstock and Comstock models for each building stock and enduse equipment type for all 50 states plus the District of Columbia and stores the data locally in [stock_database.db](/src/models/residential/) as a a SQL database. Set **test** = True if you want to run the code for a small subset of the data. The database will be stored in the preprocessor_inputs directory.

#### Enduse Demand

The enduse demand code creates the [enduse_shapes.csv](/src/models/residential/input/preprocessor_inputs/enduse_shapes.csv) within the preprocessor_inputs directory. This file is pre-built within the project. Users can recreate this file by first running the Enduse Database script and then running the Enduse Demand script. Set **test** = True if you want to run the code for a small subset of the data. 

This code pulls the enduse equipment that consumes electricity from the enduse database and combines the building stocks and equipment types into enduse categories based on the assignments specified in the [resstock_assignements.csv](/src/models/residential/input/preprocessor_inputs/resstock_assignments.csv) and [comstock_assignments.csv](/src/models/residential/input/preprocessor_inputs/comstock_assignments.csv) files. 

Next the code creates hourly profiles for each enduse equipment, adjusting each state profile to a local time using [timezone_assignments.csv](/src/models/residential/input/preprocessor_inputs/timezone_assignments.csv) and then summing up from 15-minute interval data to hourly data. The state profiles are then summed together to create a national profile for each enduse category. The total kilowatthours for each enduse category are then converted to a percent of generation for each hour within the year. 

## Code Documentation

[Code Documentation](/docs/README.md)

